<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dotiam Map Editor</title>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            padding: 0;
            margin: 0;
            background: #0a0a0a;
            color: #00ff00;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 300px;
            border-right: 1px solid #333;
            background: #111;
            display: flex;
            flex-direction: column;
        }
        #map-area {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0d0d0d;
            overflow: auto;
        }
        pre#ascii-map {
            font-size: 1.5em;
            line-height: 1.1;
            cursor: crosshair;
            user-select: none;
            background: #000;
            padding: 10px;
            border: 1px solid #333;
        }
        .map-row {
            display: flex;
            height: 1.2em;
        }
        .map-char {
            width: 1ch;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #444;
        }
        .map-char.exists {
            color: #00ff00;
        }
        .map-char:hover {
            background: #222;
        }
        .map-char.active {
            background: #00ff00;
            color: #000;
        }
        #editor-pane {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            background: #050505;
            color: #00ff00;
            border: 1px solid #333;
            padding: 10px;
            font-family: inherit;
            resize: none;
        }
        #image-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #333;
        }
        .btn {
            background: #222;
            color: #00ff00;
            border: 1px solid #444;
            padding: 5px 10px;
            text-decoration: none;
            cursor: pointer;
            text-align: center;
        }
        .btn:hover {
            background: #333;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div style="padding: 10px; border-bottom: 1px solid #333;">
            <a href="/game/{{ run_id }}" class="btn" style="display: block;">[ BACK TO GAME ]</a>
        </div>
        <div id="editor-pane">
            {% include "partial_editor_details.html" %}
        </div>
    </div>
    <div id="map-area">
        <pre id="ascii-map" tabindex="0">{% for row in grid %}
<div class="map-row">{% for cell in row %}
<span class="map-char{% if cell.is_active %} active{% endif %}{% if cell.exists %} exists{% endif %}" 
                  id="tile-{{ cell.x }}-{{ cell.y }}"
                  hx-get="/game/{{ run_id }}/editor/tile/{{ cell.x }}/{{ cell.y }}" 
                  hx-target="#editor-pane"
                  onclick="updateCursor({{ cell.x }}, {{ cell.y }}, this)"
            >{{ cell.char }}</span>{% endfor %}</div>{% endfor %}</pre>
    </div>
    <script>
        let cursorX = {{ pos.x }};
        let cursorY = {{ pos.y }};
        const runId = "{{ run_id }}";

        function updateCursor(x, y, element) {
            cursorX = x;
            cursorY = y;
            document.querySelectorAll('.map-char').forEach(c => c.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                const el = document.getElementById(`tile-${x}-${y}`);
                if (el) el.classList.add('active');
            }
            
            // Pokud je kurzor na kraji viewportu, reloadujeme celou mapu pro posun viewportu
            // Pro jednoduchost zatím budeme navigovat přes window.location nebo HTMX na celý editor
            // Ale zkusíme nejdřív jen update detailů přes HTMX pokud je to v rámci viditelného pole.
        }

        document.addEventListener('keydown', function(e) {
            // Ignorovat pokud jsme v textarea nebo inputu
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                return;
            }

            let newX = cursorX;
            let newY = cursorY;
            let moved = false;

            if (e.key === 'ArrowUp') { newY++; moved = true; }
            else if (e.key === 'ArrowDown') { newY--; moved = true; }
            else if (e.key === 'ArrowLeft') { newX--; moved = true; }
            else if (e.key === 'ArrowRight') { newX++; moved = true; }

            if (moved) {
                e.preventDefault();
                // Omezení rozsahu
                newX = Math.max(0, Math.min(254, newX));
                newY = Math.max(0, Math.min(254, newY));
                
                // Přesměrování pro update viewportu (nebo HTMX swap)
                window.location.href = `/game/${runId}/editor?x=${newX}&y=${newY}`;
                return;
            }

            // Klávesové zkratky pro změnu dlaždice
            let tileType = null;
            if (e.key === '+') tileType = 'Crossroad';
            else if (e.key === '-') tileType = 'HorizontalPath';
            else if (e.key === '|') tileType = 'VerticalPath';
            else if (e.key === ' ') tileType = 'Empty'; // Speciální případ pro smazání

            if (tileType) {
                e.preventDefault();
                updateTile(cursorX, cursorY, tileType);
            } else if (e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        function updateTile(x, y, type) {
            // Použijeme existující endpoint pro update popisu/typu, ale upravený pro rychlou změnu
            const formData = new FormData();
            formData.append('tile_type', type);
            
            fetch(`/game/${runId}/editor/tile/${x}/${y}/quick_update`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    window.location.reload(); // Pro nejjednodušší update celé mapy
                }
            });
        }

        function undo() {
            fetch(`/game/${runId}/editor/undo`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
        }

        // Fokus na mapu při načtení
        document.getElementById('ascii-map').focus();
    </script>
</body>
</html>
